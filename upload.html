<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Resources - Learnify</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📤</text></svg>">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --dark: #1b263b;
            --light: #f8f9fa;
            --success: #4cc9f0;
            --warning: #f72585;
            --radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --primary: #4895ef;
            --secondary: #4361ee;
            --accent: #3f37c9;
            --dark: #f8f9fa;
            --light: #1b263b;
            --success: #4cc9f0;
            --warning: #f72585;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            transition: var(--transition);
            min-height: 100vh;
        }

        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .logo-icon {
            font-size: 2rem;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .upload-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .upload-title {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary);
        }

        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .file-upload {
            border: 2px dashed #ddd;
            padding: 2rem;
            text-align: center;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .file-upload:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .file-upload input {
            display: none;
        }

        .file-upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .file-upload-text {
            margin-bottom: 0.5rem;
        }

        .file-upload-hint {
            font-size: 0.9rem;
            color: #666;
        }

        .file-selected {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f0f0f0;
            border-radius: var(--radius);
        }

        .file-selected-name {
            font-weight: 500;
        }

        .file-selected-size {
            font-size: 0.9rem;
            color: #666;
        }

        .upload-btn {
            padding: 1rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .upload-btn:hover {
            background-color: var(--secondary);
        }

        .upload-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .progress-container {
            margin-top: 1rem;
            display: none;
        }

        .progress-bar {
            height: 10px;
            background-color: #f0f0f0;
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
        }

        .upload-success {
            display: none;
            text-align: center;
            padding: 2rem;
            background-color: rgba(76, 201, 240, 0.1);
            border-radius: var(--radius);
            margin-top: 2rem;
        }

        .success-icon {
            font-size: 3rem;
            color: var(--success);
            margin-bottom: 1rem;
            animation: bounce 1s;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-20px);}
            60% {transform: translateY(-10px);}
        }

        .error-message {
            color: var(--warning);
            text-align: center;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        footer {
            background-color: var(--dark);
            color: white;
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 1rem;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-links a:hover {
            color: var(--accent);
        }

        .copyright {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            nav ul {
                gap: 10px;
            }

            .upload-container {
                margin: 1rem;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span class="logo-icon">📚</span>
            <span>Learnify</span>
        </div>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/upload">Upload</a></li>
                <li><a href="/admin">Admin</a></li>
                <li><a href="/terms">Terms</a></li>
            </ul>
        </nav>
        <button class="theme-toggle" id="themeToggle">🌓</button>
    </header>

    <div class="upload-container">
        <h1 class="upload-title">Upload Learning Resource</h1>
        
        <form class="upload-form" id="uploadForm">
            <div class="form-group">
                <label for="resourceTitle">Resource Title*</label>
                <input type="text" id="resourceTitle" placeholder="e.g. Mathematics Paper 1 2025" required>
            </div>
            
            <div class="form-group">
                <label for="resourceLevel">Level*</label>
                <select id="resourceLevel" required>
                    <option value="">Select Level</option>
                    <option value="O Level">O Level</option>
                    <option value="A Level">A Level</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="resourceType">Resource Type*</label>
                <select id="resourceType" required>
                    <option value="">Select Type</option>
                    <option value="Textbook">Textbook</option>
                    <option value="Question Paper">Question Paper</option>
                    <option value="Marking Scheme">Marking Scheme</option>
                    <option value="Syllabus">Syllabus</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="uploaderName">Your Name (for credits)</label>
                <input type="text" id="uploaderName" placeholder="e.g. Darrell Mucheri">
            </div>
            
            <div class="form-group">
                <label for="resourceDescription">Description (optional)</label>
                <textarea id="resourceDescription" placeholder="Brief description of the resource..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Resource File*</label>
                <div class="file-upload" id="fileUpload">
                    <div class="file-upload-icon">📁</div>
                    <div class="file-upload-text">Click to select file or drag and drop</div>
                    <div class="file-upload-hint">Supports PDF, DOCX (Max 100MB)</div>
                    <input type="file" id="resourceFile" accept=".pdf,.docx" required>
                </div>
                <div class="file-selected" id="fileSelected">
                    <div class="file-selected-name" id="fileName"></div>
                    <div class="file-selected-size" id="fileSize"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Cover Image (optional)</label>
                <div class="file-upload" id="coverUpload">
                    <div class="file-upload-icon">🖼️</div>
                    <div class="file-upload-text">Click to select cover image</div>
                    <div class="file-upload-hint">Supports JPG, PNG (Max 5MB)</div>
                    <input type="file" id="coverImage" accept="image/*">
                </div>
                <div class="file-selected" id="coverSelected">
                    <div class="file-selected-name" id="coverName"></div>
                    <div class="file-selected-size" id="coverSize"></div>
                </div>
            </div>
            
            <button type="submit" class="upload-btn" id="submitBtn" disabled>Upload Resource</button>
            <div id="formError" class="error-message"></div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Uploading: 0%</div>
            </div>
        </form>
        
        <div class="upload-success" id="uploadSuccess">
            <div class="success-icon">🎉</div>
            <h2>Upload Successful!</h2>
            <p>Your resource has been uploaded and will be available to everyone shortly.</p>
            <button class="upload-btn" id="uploadAnother" style="margin-top: 1rem;">Upload Another</button>
        </div>
    </div>

    <footer>
        <div class="footer-links">
            <a href="/terms">Terms of Service</a>
            <a href="#">Privacy Policy</a>
            <a href="#">Contact Us</a>
            <a href="#">About Learnify</a>
        </div>
        <p class="copyright">© 2023 Learnify. Created by Darrell Mucheri. All rights reserved.</p>
    </footer>

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBId6e837ZmLhkzvDozFeJyn0EXUhF_Ftg",
            authDomain: "zimxcel.firebaseapp.com",
            projectId: "zimxcel",
            storageBucket: "zimxcel.appspot.com",
            messagingSenderId: "73188096891",
            appId: "1:73188096891:web:ed9a0b34ff8d9dc79b5bde",
            measurementId: "G-38VCEG9G6R"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM elements
        const themeToggle = document.getElementById('themeToggle');
        const uploadForm = document.getElementById('uploadForm');
        const resourceTitle = document.getElementById('resourceTitle');
        const resourceLevel = document.getElementById('resourceLevel');
        const resourceType = document.getElementById('resourceType');
        const uploaderName = document.getElementById('uploaderName');
        const resourceDescription = document.getElementById('resourceDescription');
        const fileUpload = document.getElementById('fileUpload');
        const resourceFile = document.getElementById('resourceFile');
        const fileSelected = document.getElementById('fileSelected');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const coverUpload = document.getElementById('coverUpload');
        const coverImage = document.getElementById('coverImage');
        const coverSelected = document.getElementById('coverSelected');
        const coverName = document.getElementById('coverName');
        const coverSize = document.getElementById('coverSize');
        const submitBtn = document.getElementById('submitBtn');
        const formError = document.getElementById('formError');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const uploadSuccess = document.getElementById('uploadSuccess');
        const uploadAnother = document.getElementById('uploadAnother');

        // Theme toggle functionality
        themeToggle.addEventListener('click', () => {
            document.body.setAttribute('data-theme', 
                document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        });

        // File upload handling
        fileUpload.addEventListener('click', () => resourceFile.click());
        coverUpload.addEventListener('click', () => coverImage.click());

        resourceFile.addEventListener('change', handleFileSelect);
        coverImage.addEventListener('change', handleCoverSelect);

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (!validTypes.includes(file.type)) {
                formError.textContent = 'Please upload a PDF or DOCX file.';
                resourceFile.value = '';
                return;
            }

            // Validate file size (100MB max)
            if (file.size > 100 * 1024 * 1024) {
                formError.textContent = 'File size exceeds 100MB limit.';
                resourceFile.value = '';
                return;
            }

            formError.textContent = '';
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileSelected.style.display = 'block';
            checkFormValidity();
        }

        function handleCoverSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                formError.textContent = 'Please upload an image file (JPG, PNG).';
                coverImage.value = '';
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                formError.textContent = 'Cover image exceeds 5MB limit.';
                coverImage.value = '';
                return;
            }

            formError.textContent = '';
            coverName.textContent = file.name;
            coverSize.textContent = formatFileSize(file.size);
            coverSelected.style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        // Form validation
        function checkFormValidity() {
            submitBtn.disabled = !(
                resourceTitle.value.trim() && 
                resourceLevel.value && 
                resourceType.value && 
                resourceFile.files.length > 0
            );
        }

        resourceTitle.addEventListener('input', checkFormValidity);
        resourceLevel.addEventListener('change', checkFormValidity);
        resourceType.addEventListener('change', checkFormValidity);

        // Form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formError.textContent = '';
            
            const title = resourceTitle.value.trim();
            const level = resourceLevel.value;
            const type = resourceType.value;
            const uploader = uploaderName.value.trim();
            const description = resourceDescription.value.trim();
            const file = resourceFile.files[0];
            const cover = coverImage.files[0];

            // Show progress
            progressContainer.style.display = 'block';
            submitBtn.disabled = true;

            try {
                // Upload the main file
                const filePath = `resources/${Date.now()}_${file.name}`;
                const fileRef = ref(storage, filePath);
                const fileUploadTask = uploadBytesResumable(fileRef, file);

                // Upload cover image if exists
                let coverPath = null;
                if (cover) {
                    coverPath = `covers/${Date.now()}_${cover.name}`;
                    const coverRef = ref(storage, coverPath);
                    await uploadBytesResumable(coverRef, cover);
                }

                // Track upload progress
                fileUploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `Uploading: ${Math.round(progress)}%`;
                    },
                    (error) => {
                        formError.textContent = `Upload failed: ${error.message}`;
                        progressContainer.style.display = 'none';
                        submitBtn.disabled = false;
                    },
                    async () => {
                        // Get download URLs
                        const fileUrl = await getDownloadURL(fileUploadTask.snapshot.ref);
                        let coverUrl = null;
                        if (coverPath) {
                            coverUrl = await getDownloadURL(ref(storage, coverPath));
                        }

                        // Create resource document in Firestore
                        const resourceData = {
                            title,
                            level,
                            type,
                            uploaderName: uploader || 'Anonymous',
                            description: description || '',
                            filePath,
                            fileUrl,
                            coverPath: coverPath || null,
                            coverUrl: coverUrl || null,
                            uploadDate: serverTimestamp(),
                            views: 0,
                            keywords: generateKeywords(title)
                        };

                        await addDoc(collection(db, 'resources'), resourceData);

                        // Show success message
                        uploadForm.style.display = 'none';
                        progressContainer.style.display = 'none';
                        uploadSuccess.style.display = 'block';
                    }
                );

            } catch (error) {
                formError.textContent = `Error: ${error.message}`;
                progressContainer.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Generate search keywords from title
        function generateKeywords(title) {
            const words = title.toLowerCase().split(/\s+/);
            const keywords = new Set();
            
            // Add all possible substrings
            for (let i = 0; i < words.length; i++) {
                let substring = '';
                for (let j = i; j < words.length; j++) {
                    substring = (substring + ' ' + words[j]).trim();
                    keywords.add(substring);
                }
            }
            
            return Array.from(keywords);
        }

        // Upload another resource
        uploadAnother.addEventListener('click', () => {
            uploadForm.reset();
            uploadForm.style.display = 'block';
            uploadSuccess.style.display = 'none';
            fileSelected.style.display = 'none';
            coverSelected.style.display = 'none';
            submitBtn.disabled = true;
        });

        // Drag and drop functionality
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.style.borderColor = var(--primary);
            fileUpload.style.backgroundColor = 'rgba(67, 97, 238, 0.1)';
        });

        fileUpload.addEventListener('dragleave', () => {
            fileUpload.style.borderColor = '#ddd';
            fileUpload.style.backgroundColor = '';
        });

        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.style.borderColor = '#ddd';
            fileUpload.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length) {
                resourceFile.files = e.dataTransfer.files;
                handleFileSelect({ target: { files: e.dataTransfer.files } });
            }
        });
    </script>
</body>
</html>
